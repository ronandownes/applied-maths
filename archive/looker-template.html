<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>__BOOK_NAME__ - Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }
        
        /* iOS specific fullscreen fixes */
        :-webkit-full-screen {
            width: 100% !important;
            height: 100% !important;
        }
        :-moz-full-screen {
            width: 100% !important;
            height: 100% !important;
        }
        :-ms-fullscreen {
            width: 100% !important;
            height: 100% !important;
        }
        :fullscreen {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Always visible TOC toggle button */
        .toc-toggle-fixed {
            position: fixed;
            top: 80px;
            left: 0;
            z-index: 2000;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            padding: 10px 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.3);
        }
        
        .toc-toggle-fixed:hover {
            background: #0080ff;
            padding-left: 12px;
        }
        
        /* Sidebar TOC */
        .toc-sidebar {
            width: 300px;
            background: #2a2a2a;
            border-right: 1px solid #3a3a3a;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, width 0.3s ease;
            z-index: 1000;
            flex-shrink: 0;
        }
        
        .toc-collapsed .toc-sidebar {
            transform: translateX(-300px);
            width: 0;
        }
        
        .toc-collapsed .toc-toggle-fixed {
            left: 0;
        }
        
        .toc-header {
            padding: 16px;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2a2a2a;
        }
        
        .toc-header h2 {
            font-size: 18px;
            color: #fff;
        }
        
        .toc-close {
            background: none;
            border: none;
            color: #e0e0e0;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .toc-close:hover {
            background: #3a3a3a;
        }
        
        .toc-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        
        .toc-chapter {
            margin-bottom: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .toc-chapter-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: #3a3a3a;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }
        
        .toc-chapter-header:hover {
            background: #4a4a4a;
        }
        
        .chapter-expand {
            color: #66b3ff;
            font-size: 14px;
            width: 20px;
            text-align: center;
            transition: transform 0.2s;
        }
        
        .chapter-expand.expanded {
            transform: rotate(90deg);
        }
        
        .chapter-number {
            color: #66b3ff;
            font-weight: bold;
            font-size: 14px;
            min-width: 36px;
        }
        
        .toc-chapter-title {
            font-weight: bold;
            font-size: 14px;
            flex: 1;
        }
        
        .toc-sections {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: #2a2a2a;
        }
        
        .toc-chapter.expanded .toc-sections {
            max-height: 1000px;
        }
        
        .toc-section {
            padding: 8px 12px 8px 52px;
            font-size: 13px;
            cursor: pointer;
            border-radius: 2px;
            margin: 1px 4px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-number {
            color: #888;
            font-size: 12px;
            min-width: 40px;
        }
        
        .section-title {
            flex: 1;
        }
        
        .toc-section:hover {
            background: #3a3a3a;
        }
        
        .toc-section.active {
            background: #4a4a4a;
            color: #fff;
        }
        
        .toc-section.active .section-number {
            color: #fff;
            font-weight: bold;
        }
        
        /* Main viewer */
        .viewer {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: margin-left 0.3s ease;
        }
        
        .toc-collapsed .viewer {
            margin-left: 0;
        }
        
        /* Controls - compact */
        .controls {
            background: #2a2a2a;
            padding: 6px 8px;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
            z-index: 100;
        }
        
        button {
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            color: #e0e0e0;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            min-width: 28px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }
        
        button:hover {
            background: #4a4a4a;
            border-color: #5a5a5a;
        }
        
        button.active {
            background: #0066cc;
            border-color: #0080ff;
        }
        
        button.copied {
            background: #2e7d32 !important;
            border-color: #4caf50 !important;
        }
        
        /* Page info - horizontal with / separator */
        .page-info {
            display: inline-flex;
            align-items: baseline;
            font-size: 11px;
            margin: 0 6px;
            gap: 1px;
        }
        
        /* Editable current page */
        #current-page {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            min-width: 20px;
            text-align: center;
            display: inline-block;
        }
        
        #current-page:hover {
            background: #3a3a3a;
        }
        
        .page-slash {
            color: #666;
            font-size: 10px;
        }
        
        #total-pages {
            color: #888;
            font-size: 9px;
        }
        
        /* Inline page input - replaces the span */
        .page-input-inline {
            width: 36px;
            padding: 2px 4px;
            font-size: 11px;
            text-align: center;
            background: #1a1a1a;
            border: 1px solid #0066cc;
            border-radius: 3px;
            color: #e0e0e0;
            outline: none;
            -moz-appearance: textfield;
        }
        
        .page-input-inline::-webkit-outer-spin-button,
        .page-input-inline::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .fit-controls {
            display: flex;
            gap: 2px;
            margin: 0 4px;
        }
        
        /* Image container */
        .image-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow: auto;
            padding: 0;
            background: #1a1a1a;
            position: relative;
            width: 100%;
        }
        
        .image-container.fit-width {
            justify-content: flex-start;
        }
        
        .image-container.fit-height {
            justify-content: center;
            align-items: center;
        }
        
        .image-container.fit-height img {
            height: 100% !important;
            width: auto !important;
            object-fit: contain;
            max-width: 100%;
        }
        
        .image-container.fit-width img {
            width: 100% !important;
            height: auto !important;
            object-fit: contain;
        }
        
        #page-image {
            display: block;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s ease;
            margin: 0;
        }
        
        /* Navigation overlay */
        .nav-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            pointer-events: none;
            z-index: 50;
        }
        
        .nav-left, .nav-right {
            flex: 1;
            pointer-events: auto;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .nav-left:hover, .nav-right:hover {
            opacity: 0.1;
        }
        
        .nav-left:hover {
            background: linear-gradient(90deg, rgba(0,0,0,0.3), transparent);
        }
        
        .nav-right:hover {
            background: linear-gradient(270deg, rgba(0,0,0,0.3), transparent);
        }
        
        /* Zoom indicator */
        .zoom-indicator {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            display: none;
            z-index: 100;
        }
        
        /* Copy link button feedback */
        .copy-link-btn {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .copy-link-tooltip {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: #2e7d32;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 1000;
        }
        
        .copy-link-tooltip.show {
            opacity: 1;
        }
        
        /* No TOC message */
        .no-toc {
            text-align: center;
            padding: 40px 20px;
            color: #888;
            font-style: italic;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .toc-sidebar {
                width: 280px;
            }
            
            .toc-collapsed .toc-sidebar {
                transform: translateX(-280px);
            }
            
            .toc-toggle-fixed {
                top: 70px;
                padding: 8px 6px;
            }
            
            .controls {
                padding: 4px 6px;
                gap: 3px;
            }
            
            button {
                padding: 5px 6px;
                font-size: 11px;
                min-width: 24px;
            }
            
            .page-info {
                font-size: 10px;
                margin: 0 4px;
            }
            
            #total-pages {
                font-size: 8px;
            }
        }
        
        /* Discrete scrollbar - thin and subtle */
        .image-container::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .image-container::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .image-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .image-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        
        /* Firefox scrollbar */
        .image-container {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }
    </style>
</head>
<body class="toc-collapsed">
    <!-- Always visible TOC toggle button -->
    <button class="toc-toggle-fixed" id="toc-toggle-fixed" title="Show/Hide Table of Contents (T)">
        ðŸ“–
    </button>

    <!-- Sidebar TOC -->
    <div class="toc-sidebar">
        <div class="toc-header">
            <h2>Table of Contents</h2>
            <button class="toc-close" id="toc-close" title="Close">Ã—</button>
        </div>
        <div class="toc-content" id="toc-content">
            <!-- TOC will be populated by JavaScript -->
        </div>
    </div>

    <!-- Main Viewer -->
    <div class="viewer" id="main-viewer">
        <!-- Controls -->
        <div class="controls">
            <button id="prev" title="Previous Page (â†)">â—€</button>
            <button id="next" title="Next Page (â†’)">â–¶</button>
            
            <!-- Clickable page info - click page number to type destination -->
            <span class="page-info">
                <span id="current-page" title="Click to go to page">1</span>
                <span class="page-slash">/</span>
                <span id="total-pages">__PAGES_COUNT__</span>
            </span>
            
            <div class="fit-controls">
                <button id="fit-height" title="Fit Height (H)" class="active">â†•</button>
                <button id="fit-width" title="Fit Width (W)">â†”</button>
            </div>
            
            <button id="zoom-in" title="Zoom In (+)">+</button>
            <button id="zoom-out" title="Zoom Out (-)">âˆ’</button>
            <button id="zoom-reset" title="Reset Zoom (0)">âŸ²</button>
            
            <div style="flex: 1"></div>
            
            <button id="copy-link" class="copy-link-btn" title="Copy Link to Current Page (Ctrl+C)">
                ðŸ“Ž
                <span class="copy-link-tooltip">Copied!</span>
            </button>
            
            <button id="fullscreen" title="Fullscreen (F)">â›¶</button>
        </div>

        <!-- Image Container -->
        <div class="image-container" id="image-container">
            <div class="nav-overlay">
                <div class="nav-left" id="nav-left"></div>
                <div class="nav-right" id="nav-right"></div>
            </div>
            <img id="page-image" src="" alt="Page">
            <div class="zoom-indicator" id="zoom-indicator"></div>
        </div>
    </div>

    <script>
        // Configuration
        const config = {
            pages: __PAGES__,
            imgBase: __IMG_BASE__,
            toc: __TOC__,
            currentPage: 0,
            zoom: 1.0,
            isPanning: false,
            startX: 0,
            startY: 0,
            translateX: 0,
            translateY: 0,
            baseImgWidth: 0,
            baseImgHeight: 0,
            lastMouseX: 0,
            lastMouseY: 0,
            currentFitMode: localStorage.getItem('fitMode') || 'height',
            expandedChapters: JSON.parse(localStorage.getItem('expandedChapters') || '{}')
        };
        
        const fitModes = {
            height: {
                name: "height",
                apply: function(img, container) {
                    img.classList.add('fit-height');
                    img.classList.remove('fit-width');
                    container.classList.add('fit-height');
                    container.classList.remove('fit-width');
                    img.style.maxWidth = 'none';
                    img.style.maxHeight = '100%';
                    img.style.width = 'auto';
                    img.style.height = 'auto';
                    img.style.objectFit = 'contain';
                },
                remove: function(img, container) {
                    img.classList.remove('fit-height');
                    container.classList.remove('fit-height');
                }
            },
            width: {
                name: "width",
                apply: function(img, container) {
                    img.classList.add('fit-width');
                    img.classList.remove('fit-height');
                    container.classList.add('fit-width');
                    container.classList.remove('fit-height');
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = 'none';
                    img.style.width = 'auto';
                    img.style.height = 'auto';
                    img.style.objectFit = 'contain';
                },
                remove: function(img, container) {
                    img.classList.remove('fit-width');
                    container.classList.remove('fit-width');
                }
            }
        };
        
        // DOM elements
        const pageImage = document.getElementById('page-image');
        const currentPageSpan = document.getElementById('current-page');
        const totalPagesSpan = document.getElementById('total-pages');
        const tocContent = document.getElementById('toc-content');
        const zoomIndicator = document.getElementById('zoom-indicator');
        const tocToggleFixed = document.getElementById('toc-toggle-fixed');
        const tocClose = document.getElementById('toc-close');
        const copyLinkBtn = document.getElementById('copy-link');
        const copyLinkTooltip = document.querySelector('.copy-link-tooltip');
        const imageContainer = document.getElementById('image-container');
        
        // Fullscreen toggle function that works on all platforms
        function toggleFullscreen() {
            const elem = document.documentElement;
            
            if (elem.requestFullscreen) {
                if (!document.fullscreenElement) {
                    elem.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            } else if (elem.webkitRequestFullscreen) {
                if (!document.webkitFullscreenElement) {
                    elem.webkitRequestFullscreen();
                } else {
                    document.webkitExitFullscreen();
                }
            } else if (elem.mozRequestFullScreen) {
                if (!document.mozFullScreenElement) {
                    elem.mozRequestFullScreen();
                } else {
                    document.mozCancelFullScreen();
                }
            } else if (elem.msRequestFullscreen) {
                if (!document.msFullscreenElement) {
                    elem.msRequestFullscreen();
                } else {
                    document.msExitFullscreen();
                }
            }
        }
        
        // Update fullscreen button state
        function updateFullscreenButton() {
            const fullscreenBtn = document.getElementById('fullscreen');
            const isFullscreen = 
                document.fullscreenElement ||
                document.webkitFullscreenElement ||
                document.mozFullScreenElement ||
                document.msFullscreenElement;
            fullscreenBtn.textContent = isFullscreen ? 'â›¶' : 'â›¶';
        }
        
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('mozfullscreenchange', updateFullscreenButton);
        document.addEventListener('MSFullscreenChange', updateFullscreenButton);
        
        // Initialize
        function init() {
            totalPagesSpan.textContent = config.pages.length;
            loadPage(config.currentPage);
            renderTOC();
            setupEventListeners();
            loadPreferences();
            
            if (config.toc.chapters && config.toc.chapters.length > 0) {
                setTimeout(() => {
                    toggleTOC(true);
                }, 100);
            }
        }
        
        // Load preferences
        function loadPreferences() {
            const savedPage = localStorage.getItem('currentPage');
            if (savedPage !== null) {
                const pageNum = parseInt(savedPage);
                if (pageNum >= 0 && pageNum < config.pages.length) {
                    config.currentPage = pageNum;
                    loadPage(config.currentPage);
                }
            }
            
            setFitMode(config.currentFitMode);
            
            const tocState = localStorage.getItem('tocVisible');
            if (tocState === 'true') {
                toggleTOC(true);
            }
        }
        
        // Toggle TOC visibility
        function toggleTOC(show) {
            const body = document.body;
            if (show === undefined) {
                show = body.classList.contains('toc-collapsed');
            }
            
            if (show) {
                body.classList.remove('toc-collapsed');
                tocToggleFixed.innerHTML = 'ðŸ“–';
                tocToggleFixed.title = 'Hide Table of Contents (T)';
            } else {
                body.classList.add('toc-collapsed');
                tocToggleFixed.innerHTML = 'ðŸ“–';
                tocToggleFixed.title = 'Show Table of Contents (T)';
            }
            
            localStorage.setItem('tocVisible', show);
            
            setTimeout(() => {
                if (config.currentFitMode === 'width') {
                    setFitMode('width');
                }
            }, 50);
        }
        
        // Set fit mode
        function setFitMode(mode) {
            config.currentFitMode = mode;
            
            for (const m in fitModes) {
                fitModes[m].remove(pageImage, imageContainer);
            }
            
            fitModes[mode].apply(pageImage, imageContainer);
            
            document.getElementById('fit-height').classList.remove('active');
            document.getElementById('fit-width').classList.remove('active');
            document.getElementById('fit-' + mode).classList.add('active');
            
            config.zoom = 1.0;
            config.translateX = 0;
            config.translateY = 0;
            updateImageTransform();
            
            localStorage.setItem('fitMode', mode);
            
            imageContainer.scrollTop = 0;
            imageContainer.scrollLeft = 0;
        }
        
        // Load page
        function loadPage(index) {
            if (index < 0 || index >= config.pages.length) return;
            
            config.currentPage = index;
            const pageName = config.pages[index];
            const imgPath = config.imgBase ? `${config.imgBase}/${pageName}` : pageName;
            
            pageImage.src = imgPath;
            currentPageSpan.textContent = index + 1;
            
            config.zoom = 1.0;
            config.translateX = 0;
            config.translateY = 0;
            updateImageTransform();
            
            imageContainer.scrollTop = 0;
            imageContainer.scrollLeft = 0;
            
            updateActiveTOCItem();
            
            localStorage.setItem('currentPage', index);
        }
        
        // Cache image dimensions when loaded (for pan constraints)
        pageImage.addEventListener('load', function() {
            config.baseImgWidth = pageImage.offsetWidth;
            config.baseImgHeight = pageImage.offsetHeight;
        });
        
        // Render TOC
        function renderTOC() {
            if (!config.toc.chapters || config.toc.chapters.length === 0) {
                tocContent.innerHTML = '<div class="no-toc">No table of contents available</div>';
                return;
            }
            
            let html = '';
            
            config.toc.chapters.forEach((chapter, chapterIndex) => {
                const chapterCode = chapter.code || `Chapter ${chapterIndex + 1}`;
                const isExpanded = config.expandedChapters[chapterIndex] === true || 
                                   (chapterIndex === 0 && Object.keys(config.expandedChapters).length === 0);
                
                html += `
                    <div class="toc-chapter ${isExpanded ? 'expanded' : ''}" data-index="${chapterIndex}">
                        <div class="toc-chapter-header">
                            <span class="chapter-expand ${isExpanded ? 'expanded' : ''}">â–¶</span>
                            <div class="chapter-number">${chapterCode}</div>
                            <div class="toc-chapter-title" data-start="${chapter.start - 1}">
                                ${chapter.title}
                            </div>
                        </div>
                        <div class="toc-sections">
                `;
                
                if (chapter.sections && chapter.sections.length > 0) {
                    chapter.sections.forEach(section => {
                        const sectionCode = section.code || '';
                        html += `
                            <div class="toc-section" data-start="${section.start - 1}">
                                <div class="section-number">${sectionCode}</div>
                                <div class="section-title">${section.title}</div>
                            </div>
                        `;
                    });
                }
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            tocContent.innerHTML = html;
            
            document.querySelectorAll('.toc-chapter-header').forEach(header => {
                header.addEventListener('click', function(e) {
                    const chapter = this.parentElement;
                    const chapterIndex = parseInt(chapter.getAttribute('data-index'));
                    const isExpanded = chapter.classList.contains('expanded');
                    
                    if (e.target.classList.contains('chapter-expand') || 
                        e.target.classList.contains('chapter-number')) {
                        chapter.classList.toggle('expanded');
                        this.querySelector('.chapter-expand').classList.toggle('expanded');
                        
                        config.expandedChapters[chapterIndex] = !isExpanded;
                        localStorage.setItem('expandedChapters', JSON.stringify(config.expandedChapters));
                    } else {
                        const startIndex = parseInt(this.querySelector('.toc-chapter-title').getAttribute('data-start'));
                        if (!isNaN(startIndex) && startIndex >= 0 && startIndex < config.pages.length) {
                            loadPage(startIndex);
                            toggleTOC(false);
                        }
                    }
                });
            });
            
            document.querySelectorAll('.toc-section').forEach(section => {
                section.addEventListener('click', function() {
                    const startIndex = parseInt(this.getAttribute('data-start'));
                    if (!isNaN(startIndex) && startIndex >= 0 && startIndex < config.pages.length) {
                        loadPage(startIndex);
                        toggleTOC(false);
                        
                        const chapter = this.closest('.toc-chapter');
                        const chapterIndex = parseInt(chapter.getAttribute('data-index'));
                        if (!chapter.classList.contains('expanded')) {
                            chapter.classList.add('expanded');
                            chapter.querySelector('.chapter-expand').classList.add('expanded');
                            config.expandedChapters[chapterIndex] = true;
                            localStorage.setItem('expandedChapters', JSON.stringify(config.expandedChapters));
                        }
                    }
                });
            });
        }
        
        // Update active TOC item
        function updateActiveTOCItem() {
            document.querySelectorAll('.toc-section').forEach(item => {
                item.classList.remove('active');
            });
            
            let activeItem = null;
            let minDistance = Infinity;
            
            document.querySelectorAll('.toc-section').forEach(item => {
                const startIndex = parseInt(item.getAttribute('data-start'));
                if (!isNaN(startIndex)) {
                    const distance = Math.abs(config.currentPage - startIndex);
                    if (distance < minDistance && config.currentPage >= startIndex) {
                        minDistance = distance;
                        activeItem = item;
                    }
                }
            });
            
            if (activeItem) {
                activeItem.classList.add('active');
                
                setTimeout(() => {
                    activeItem.scrollIntoView({ block: 'center', behavior: 'smooth' });
                }, 100);
            }
        }
        
        // Constrain pan to keep image visible - can't drag past edges
        function constrainPan() {
            if (config.zoom <= 1.0) {
                config.translateX = 0;
                config.translateY = 0;
                return;
            }
            
            // Get container size
            const containerWidth = imageContainer.clientWidth;
            const containerHeight = imageContainer.clientHeight;
            
            // Use cached base dimensions or estimate from container
            const imgWidth = config.baseImgWidth || containerWidth;
            const imgHeight = config.baseImgHeight || containerHeight;
            
            // Scaled size
            const scaledWidth = imgWidth * config.zoom;
            const scaledHeight = imgHeight * config.zoom;
            
            // How much bigger the scaled image is than the container
            const overflowX = Math.max(0, (scaledWidth - containerWidth) / 2);
            const overflowY = Math.max(0, (scaledHeight - containerHeight) / 2);
            
            // Constrain - allow panning only within the overflow area
            config.translateX = Math.max(-overflowX, Math.min(overflowX, config.translateX));
            config.translateY = Math.max(-overflowY, Math.min(overflowY, config.translateY));
        }
        
        // Update image transform with pan constraints
        function updateImageTransform() {
            constrainPan();
            pageImage.style.transform = `translate(${config.translateX}px, ${config.translateY}px) scale(${config.zoom})`;
            
            if (config.zoom !== 1.0) {
                zoomIndicator.textContent = `${Math.round(config.zoom * 100)}%`;
                zoomIndicator.style.display = 'block';
                setTimeout(() => {
                    zoomIndicator.style.display = 'none';
                }, 1000);
            }
        }
        
        // Show inline page input - replaces span with input
        function showPageInput() {
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'page-input-inline';
            input.min = 1;
            input.max = config.pages.length;
            input.value = config.currentPage + 1;
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitPageInput(input);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    hidePageInput(input);
                }
            });
            
            input.addEventListener('blur', () => {
                submitPageInput(input);
            });
            
            currentPageSpan.style.display = 'none';
            currentPageSpan.parentNode.insertBefore(input, currentPageSpan);
            input.focus();
            input.select();
        }
        
        // Hide inline page input - restore span
        function hidePageInput(input) {
            currentPageSpan.style.display = '';
            if (input && input.parentNode) {
                input.parentNode.removeChild(input);
            }
        }
        
        // Handle page input submission
        function submitPageInput(input) {
            const pageNum = parseInt(input.value);
            if (!isNaN(pageNum) && pageNum >= 1 && pageNum <= config.pages.length) {
                loadPage(pageNum - 1);
            }
            hidePageInput(input);
        }
        
        // Copy current page link with visual feedback
        function copyCurrentLink() {
            const currentUrl = new URL(window.location.href);
            currentUrl.hash = `#page=${config.currentPage + 1}`;
            const link = currentUrl.toString();
            
            navigator.clipboard.writeText(link).then(() => {
                copyLinkBtn.classList.add('copied');
                copyLinkBtn.innerHTML = 'âœ“';
                copyLinkBtn.title = 'Link copied to clipboard!';
                
                copyLinkTooltip.classList.add('show');
                
                setTimeout(() => {
                    copyLinkBtn.classList.remove('copied');
                    copyLinkBtn.innerHTML = 'ðŸ“Ž';
                    copyLinkBtn.title = 'Copy Link to Current Page (Ctrl+C)';
                    copyLinkTooltip.classList.remove('show');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy link: ', err);
                const textArea = document.createElement('textarea');
                textArea.value = link;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                copyLinkBtn.classList.add('copied');
                copyLinkBtn.innerHTML = 'âœ“';
                copyLinkTooltip.textContent = 'Copied!';
                copyLinkTooltip.classList.add('show');
                
                setTimeout(() => {
                    copyLinkBtn.classList.remove('copied');
                    copyLinkBtn.innerHTML = 'ðŸ“Ž';
                    copyLinkTooltip.classList.remove('show');
                }, 2000);
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('prev').addEventListener('click', () => {
                loadPage(config.currentPage - 1);
            });
            
            document.getElementById('next').addEventListener('click', () => {
                loadPage(config.currentPage + 1);
            });
            
            document.getElementById('fit-height').addEventListener('click', () => {
                setFitMode('height');
            });
            
            document.getElementById('fit-width').addEventListener('click', () => {
                setFitMode('width');
            });
            
            document.getElementById('zoom-in').addEventListener('click', () => {
                config.zoom = Math.min(config.zoom + 0.1, 3.0);
                updateImageTransform();
            });
            
            document.getElementById('zoom-out').addEventListener('click', () => {
                config.zoom = Math.max(config.zoom - 0.1, 0.1);
                updateImageTransform();
            });
            
            document.getElementById('zoom-reset').addEventListener('click', () => {
                config.zoom = 1.0;
                config.translateX = 0;
                config.translateY = 0;
                updateImageTransform();
            });
            
            document.getElementById('fullscreen').addEventListener('click', toggleFullscreen);
            
            copyLinkBtn.addEventListener('click', copyCurrentLink);
            
            tocToggleFixed.addEventListener('click', () => {
                toggleTOC();
            });
            
            tocClose.addEventListener('click', () => {
                toggleTOC(false);
            });
            
            // Click on current page number to edit inline
            currentPageSpan.addEventListener('click', (e) => {
                e.preventDefault();
                showPageInput();
            });
            
            document.getElementById('nav-left').addEventListener('click', (e) => {
                if (e.clientX < window.innerWidth / 2) {
                    loadPage(config.currentPage - 1);
                }
            });
            
            document.getElementById('nav-right').addEventListener('click', (e) => {
                if (e.clientX >= window.innerWidth / 2) {
                    loadPage(config.currentPage + 1);
                }
            });
            
            document.addEventListener('keydown', (e) => {
                // Don't handle keys if typing in an input
                if (e.target.tagName === 'INPUT') {
                    return;
                }
                
                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        loadPage(config.currentPage - 1);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        loadPage(config.currentPage + 1);
                        break;
                    case 'ArrowUp':
                        if (config.currentFitMode === 'width') {
                            e.preventDefault();
                            imageContainer.scrollBy(0, -50);
                        }
                        break;
                    case 'ArrowDown':
                        if (config.currentFitMode === 'width') {
                            e.preventDefault();
                            imageContainer.scrollBy(0, 50);
                        }
                        break;
                    case 'h':
                    case 'H':
                        e.preventDefault();
                        setFitMode('height');
                        break;
                    case 'w':
                    case 'W':
                        e.preventDefault();
                        setFitMode('width');
                        break;
                    case 't':
                    case 'T':
                        e.preventDefault();
                        toggleTOC();
                        break;
                    case 'g':
                    case 'G':
                        e.preventDefault();
                        showPageInput();
                        break;
                    case 'c':
                    case 'C':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            copyCurrentLink();
                        }
                        break;
                    case '+':
                    case '=':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            config.zoom = Math.min(config.zoom + 0.1, 3.0);
                            updateImageTransform();
                        }
                        break;
                    case '-':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            config.zoom = Math.max(config.zoom - 0.1, 0.1);
                            updateImageTransform();
                        }
                        break;
                    case '0':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            config.zoom = 1.0;
                            config.translateX = 0;
                            config.translateY = 0;
                            updateImageTransform();
                        }
                        break;
                    case 'f':
                    case 'F':
                        e.preventDefault();
                        toggleFullscreen();
                        break;
                }
            });
            
            pageImage.addEventListener('wheel', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? -0.1 : 0.1;
                    config.zoom = Math.max(0.1, Math.min(3.0, config.zoom + delta));
                    updateImageTransform();
                }
            });
            
            pageImage.addEventListener('mousedown', (e) => {
                if (config.zoom > 1.0) {
                    e.preventDefault();
                    config.isPanning = true;
                    config.startX = e.clientX - config.translateX;
                    config.startY = e.clientY - config.translateY;
                    pageImage.style.cursor = 'grabbing';
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                if (config.isPanning) {
                    config.translateX = e.clientX - config.startX;
                    config.translateY = e.clientY - config.startY;
                    updateImageTransform();
                }
            });
            
            document.addEventListener('mouseup', () => {
                config.isPanning = false;
                pageImage.style.cursor = 'grab';
            });
            
            // Touch panning for mobile
            let touchStartX = 0;
            let touchStartY = 0;
            let touchStartTranslateX = 0;
            let touchStartTranslateY = 0;
            let isTouchPanning = false;
            
            pageImage.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1 && config.zoom > 1.0) {
                    isTouchPanning = true;
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    touchStartTranslateX = config.translateX;
                    touchStartTranslateY = config.translateY;
                } else if (e.touches.length === 2) {
                    isTouchPanning = false;
                    e.preventDefault();
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    config.touchStartDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    config.touchStartZoom = config.zoom;
                }
            });
            
            pageImage.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1 && isTouchPanning && config.zoom > 1.0) {
                    e.preventDefault();
                    const deltaX = e.touches[0].clientX - touchStartX;
                    const deltaY = e.touches[0].clientY - touchStartY;
                    config.translateX = touchStartTranslateX + deltaX;
                    config.translateY = touchStartTranslateY + deltaY;
                    updateImageTransform();
                } else if (e.touches.length === 2) {
                    e.preventDefault();
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const currentDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    
                    config.zoom = Math.max(0.1, Math.min(3.0, 
                        config.touchStartZoom * (currentDistance / config.touchStartDistance)));
                    updateImageTransform();
                }
            });
            
            pageImage.addEventListener('touchend', () => {
                isTouchPanning = false;
            });
            
            pageImage.addEventListener('dblclick', (e) => {
                e.preventDefault();
                config.zoom = 1.0;
                config.translateX = 0;
                config.translateY = 0;
                updateImageTransform();
            });
            
            window.addEventListener('resize', () => {
                if (config.currentFitMode === 'width') {
                    setFitMode('width');
                }
            });
        }
        
        window.addEventListener('DOMContentLoaded', init);
        
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash;
            if (hash.startsWith('#page=')) {
                const pageNum = parseInt(hash.substring(6));
                if (!isNaN(pageNum) && pageNum >= 1 && pageNum <= config.pages.length) {
                    loadPage(pageNum - 1);
                }
            }
        });
        
        if (window.location.hash.startsWith('#page=')) {
            const pageNum = parseInt(window.location.hash.substring(6));
            if (!isNaN(pageNum) && pageNum >= 1 && pageNum <= config.pages.length) {
                config.currentPage = pageNum - 1;
            }
        }
    </script>
</body>
</html>
